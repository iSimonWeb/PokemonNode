<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Pok√®monNode</title>
	
	<script src="/js/jquery-1.8.2.js"></script>
	<script src="/js/canvace-0.2.4.min.js"></script>
	<style>
		body {text-align: center;}
		canvas {border: 1px solid black;}
	</style>
</head>

<body>
	<canvas width="900" height="400"></canvas>
	
	<script>
		var mainCharacterStates, character, keyboard, characterSM;
		
		var modes = ['still', 'walking', 'running'];
		var directions = ['left', 'up', 'right', 'down'];
		
		var moveKeys = {};
		var stepTimer = null;
		var userTick = function() {
			moveKeys = {
				left: keyboard.isKeyDown(KeyEvent.DOM_VK_A),
				up: keyboard.isKeyDown(KeyEvent.DOM_VK_W),
				right: keyboard.isKeyDown(KeyEvent.DOM_VK_D),
				down: keyboard.isKeyDown(KeyEvent.DOM_VK_S)
			};
			
			if (stepTimer == null && moveKeys.left) characterSM.walk('left');
			if (stepTimer == null && moveKeys.up) characterSM.walk('up');
			if (stepTimer == null && moveKeys.right) characterSM.walk('right');
			if (stepTimer == null && moveKeys.down)	characterSM.walk('down');
		};
		
		$.getJSON('Pokemon.json', {}, function (response) {
			var loader = new Canvace.Loader('media');
			loader.loadImages(response, function () {
				var canvas = $('canvas')[0];
				var stage = new Canvace.Stage(response, canvas);
				keyboard = new Canvace.Keyboard(window, true);
				var loop = new Canvace.RenderLoop(stage, null, loader, userTick);
				loop.run();
				
				mainCharacterStates = (function() {
					var states = {};
					
					$.each(modes, function(i, mode) {
						states[mode] = {};
						
						$.each(directions, function(j, direction) {
							states[mode][direction] = stage.getEntity({
								'mode': mode,
								'direction': direction
							});
						});
					});
					
					return states;
				})();
				character = stage.getInstance({});
				$(window)
					.on('focusout', function() {loop.suspend();})
					.on('focusin', function() {loop.run();});
			});
		});
		
		characterSM = new Canvace.StateMachine((function() {
			var states = {},
				walkingVelocities = {
					left: -2.8571428571428571428571428571429,
					up: -2.8571428571428571428571428571429,
					right: 2.8571428571428571428571428571429,
					down: 2.8571428571428571428571428571429
				},
				runningVelocities = {
					left: -5.8,
					up: -5.8,
					right: 5.8,
					down: 5.8
				},
				directionAxis = {
					left: 'i',
					up: 'j',
					right: 'i',
					down: 'j'
				};
			
			var resetCharacter = function(direction) {
				var axis = directionAxis[direction];
				
				character = character.replaceWith(mainCharacterStates.still[direction]);
				character.getUniformVelocity()[axis] = 0;
				character.getPosition()[axis] = Math.round(character.getPosition()[axis]);
				stepTimer = null;
			};
			
			$.each(directions, function(index, stateDirection) {
				var directionCaptzed = stateDirection.charAt(0).toUpperCase() + stateDirection.substr(1);
				
				states['still' + directionCaptzed] = {
					walk: function(direction) {
						if (direction == stateDirection) {
							character = character.replaceWith(mainCharacterStates.walking[direction]);
							character.getUniformVelocity()[directionAxis[direction]] = walkingVelocities[direction];
							stepTimer = setTimeout(resetCharacter, 350, [direction]);
							
							return 'still' + directionCaptzed;
						} else {
							character = character.replaceWith(mainCharacterStates.walking[direction]);
							stepTimer = setTimeout(resetCharacter, 50, [direction]);
							
							return 'still' + direction.charAt(0).toUpperCase() + direction.substr(1);
						}
					},
					run: function(direction) {
						character = character.replaceWith(mainCharacterStates.walking[direction]);
						character.getUniformVelocity()[directionAxis[direction]] = runningVelocities[direction];
						
						return 'running' + direction.charAt(0).toUpperCase() + direction.substr(1);
					}
				};
			});
			
			return states;
		})(), 'stillDown');
	</script>
</body>
</html>

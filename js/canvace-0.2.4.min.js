/*! Canvace Client Library - v0.2.4 - 2012-10-01
* http://www.canvace.com/
* Copyright (c) 2012 Canvace Srl */
var Canvace={};Canvace.MultiSet=function(){function d(d){var e=b++;return a[e]=d,c++,function(){return a.hasOwnProperty(e)?(delete a[e],c--,!0):!1}}var a={},b=0,c=0;(function(a){for(var b in a)d(a[b])})(arguments),this.add=d,this.forEach=function(b){for(var d in a)if(a.hasOwnProperty(d)&&b(a[d],function(b){return function(){return a.hasOwnProperty(b)?(delete a[b],c--,!0):!1}}(d))===!1)return!0;return!1},this.fastForEach=function(b){for(var c in a)a.hasOwnProperty(c)&&b(a[c])},this.count=function(){return c},this.isEmpty=function(){return!c},this.clear=function(){a={},c=0}},Canvace.List=function(){function d(c){if(!c)return null;this.element=function(){return c.element},this.previous=function(){if("removed"in c)throw{message:"no previous element, this element has been removed",element:c.element};return new d(c.previous)},this.next=function(){if("removed"in c)throw{message:"no next element, this element has been removed",element:c.element};return new d(c.next)},this.remove=function(){return"removed"in c?!1:(c.previous&&(c.previous.next=c.next),c.next&&(c.next.previous=c.previous),c==a&&(a=c.next),c==b&&(b=c.previous),c.removed=!0,!0)}}var a=null,b=null,c=0;this.addHead=function(e){return a={element:e,previous:null,next:a},b||(b=a),c++,new d(a)},this.getHead=function(){return new d(a)},this.addTail=function(e){return b={element:e,previous:b,next:null},a||(a=b),c++,new d(b)},this.getTail=function(){return new d(b)},this.count=function(){return c},this.isEmpty=function(){return!c},this.clear=function(){a=null,b=null,c=0},this.forEach=function(b){for(var c=a;c;c=c.next)if(b(c.element)===!1)return!0;return!1},this.forEachReverse=function(a){for(var c=b;c;c=c.previous)if(a(c.element)===!1)return!0;return!1}},Canvace.Heap=function(a,b){function d(a){return a*2+1}function e(a){return a*2+2}function f(a){return Math.floor((a-1)/2)}function g(b,d){return a(c[b],c[d])<0}function h(a,b){var d=c[a];c[a]=c[b],c[b]=d}function i(a){var b=d(a),f=e(a),j=a;c.length>b&&g(b,a)&&(j=b),c.length>f&&g(f,j)&&(j=f),j>a&&(h(a,j),i(j))}function j(f,g,h){return g<c.length?b(f,c[g])?(h&&h(g),!0):a(f,c[g])<0?!1:j(f,d(g),h)||j(f,e(g),h):!1}b||(b=function(a,b){return a===b});var c=[];this.push=function(a){var b=c.length;c.push(a);var d=f(b);while(b&&g(b,d))h(b,d),b=d,d=f(b)},this.pop=function(){var a=c[0],b=c.pop();return c.length&&(c[0]=b,i(0)),a},this.peek=function(){if(c.length>0)return c[0]},this.contains=function(a){return j(a,0)},this.find=function(a){var b;if(j(a,0,function(a){b=c[a]}))return b},this.decreaseKey=function(a,b){return j(a,0,function(a){b(c[a]);var d=f(a);while(a&&g(a,d))h(a,d),a=d,d=f(a)})},this.count=function(){return c.length},this.isEmpty=function(){return!c.length},this.clear=function(){c=[]}},Canvace.StateMachine=function(a,b){function f(b){if(b in a)d=a[b],e=b;else throw'invalid state "'+b+'"'}var c=function(){var b={};for(var c in a)if(a.hasOwnProperty(c))for(var d in a[c])a[c].hasOwnProperty(d)&&(b[d]=!0);return b}(),d,e;f(b),function(a){for(var b in c)c.hasOwnProperty(b)&&(a[b]=function(a){return function(){if(a in d){if(typeof d[a]=="string"){var b=d[a];return f(b),b}if(typeof d[a]=="function"){var c=d[a].apply(d,arguments);return typeof c=="string"?(f(c),c):e}throw'invalid transition "'+a+'" for state "'+e+'"'}return e}}(b))}(this),this.getCurrentState=function(){return e}},Canvace.ParametricStateMachine=function(a,b,c){function f(a){if(typeof a!="string"){if(!(0 in a))throw"invalid transition: "+a;var c=a;a=a[0];if(a in b)typeof b[a]!="function"?d=b[a]:(c.shift(),d=b[a].apply(d,c)),e=a;else throw'invalid state "'+a+'"'}else if(a in b)typeof b[a]!="function"?d=b[a]:d=b[a].call(d),e=a;else throw'invalid state "'+a+'"'}var d,e;f(c),function(b){for(var c in a)(function(a){b[a]=function(){if(a in d)if(typeof d[a]!="function")f(d[a]);else{var b=d[a].apply(d,arguments);typeof b!="undefined"&&f(b)}return e}})(a[c])}(this),this.getCurrentState=function(){return e}},Canvace.Astar=function(a){if(typeof a!="number")a=0;else if(a<0)throw"the epsilon parameter must be positive";this.findPath=function(b,c){var d={},e={},f={},g=new Canvace.Heap(function(b,c){var d=e[b.id]+b.heuristic*(1+a),f=e[c.id]+c.heuristic*(1+a);return d<f?-1:d>f?1:0},function(a,b){return a.id===b.id});e[b.id]=0,g.push(b);while(!g.isEmpty()){var h=g.pop(),i=e[h.id];delete e[h.id];if(!h.heuristic){var m=[];for(var k=h;f.hasOwnProperty(k.id);k=f[k.id].parent)m.push(f[k.id].edge);return m.reverse()}d[h.id]=!0;for(var j in h.neighbors)if(h.neighbors.hasOwnProperty(j)){var k=h.neighbors[j]();if(!d.hasOwnProperty(k.id)){var l=i+h.distance(j);e.hasOwnProperty(k.id)?l<e[k.id]&&g.decreaseKey(k,function(a){e[a.id]=l,f[a.id]={parent:h,edge:j}}):(e[k.id]=l,f[k.id]={parent:h,edge:j},g.push(k))}}}return null}},Canvace.mobileBrowser=function(a){return/android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(ad|hone|od)|iris|kindle|lge |maemo|meego.+mobile|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),typeof KeyEvent=="undefined"&&(KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_SEMICOLON:59,DOM_VK_EQUALS:61,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_CONTEXT_MENU:93,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224}),Canvace.Keyboard=function(a,b){function c(){function b(b,c){return b in a||(a[b]=new Canvace.MultiSet),a[b].add(c)}var a={};this.register=function(a,c){if(typeof a=="number")return b(a,c);var d=[];for(var e in a)d.push(b(a[e],c));return function(){for(var a in d)d()}},this.fire=function(b){return b in a?(a[b].fastForEach(function(a){a(b)}),!0):!1}}var d={},e={},f=new c,g=new c,h=new c;b===!0||typeof b=="undefined"?(a.addEventListener("keydown",function(a){var b=a.charCode||a.keyCode;d[b]?e[b]&&a.preventDefault():(d[b]=!0,f.fire(b)&&(e[b]=!0,a.preventDefault()))},!1),a.addEventListener("keypress",function(a){h.fire(a.charCode||a.keyCode)&&a.preventDefault()},!1),a.addEventListener("keyup",function(a){var b=a.charCode||a.keyCode;delete d[b],delete e[b],g.fire(b)&&a.preventDefault()},!1)):(a.addEventListener("keydown",function(a){var b=a.charCode||a.keyCode;d[b]||(d[b]=!0,f.fire(b))},!1),a.addEventListener("keypress",function(a){h.fire(a.charCode||a.keyCode)},!1),a.addEventListener("keyup",function(a){var b=a.charCode||a.keyCode;delete d[b],g.fire(b)},!1)),this.isKeyDown=function(a){return a in d},this.areKeysDown=function(){for(var a in arguments)if(!d[arguments[a]])return!1;return!0},this.onKeyDown=f.register,this.onKeyUp=function(a,b){return typeof a!="number"?g.register(a,function(){for(var c in a)if(d[a[c]])return;return b.apply(this,arguments)}):g.register(a,b)},this.onKeyPress=h.register},Canvace.Mouse=function(a){var b=new Canvace.MultiSet,c=new Canvace.MultiSet,d=new Canvace.MultiSet,e=new Canvace.MultiSet,f=!1,g,h;a.addEventListener("mousedown",function(b){var d=b.clientX-a.style.left,e=b.clientY-a.style.top;f=!0,g=d,h=e,c.fastForEach(function(a){a(d,e)})},!1),a.addEventListener("mousemove",function(c){var d=c.clientX-a.style.left,i=c.clientY-a.style.top;b.fastForEach(function(a){a(d,i)}),f&&(e.fastForEach(function(a){a(g,h,d,i)}),g=d,h=i)},!1),a.addEventListener("mouseup",function(b){var c=b.clientX-a.style.left,e=b.clientY-a.style.top;f=!1,d.fastForEach(function(a){a(c,e)})},!1),this.onMove=function(a){return b.add(a)},this.onDown=function(a){return c.add(a)},this.onUp=function(a){return d.add(a)},this.onDrag=function(a){return e.add(a)}},Canvace.Loader=function(a){var b={};this.loadImages=function(c,d,e){function h(c){for(var h in c.frames)f++,function(c){var h=new Image;h.onload=function(){++g<f?e&&e(g*100/f):d(b)},h.src=a+"/"+c,b[c]=h}(c.frames[h].id)}var f=0,g=0;for(var i in c.tiles)h(c.tiles[i]);for(var i in c.entities)h(c.entities[i]);f||d(b)},this.getImage=function(c,d){if(c in b)return b[c];var e=new Image;return e.src=a+"/"+c,d&&(e.onload=d),b[c]=e};var c={};this.loadSounds=function(b,d,e){if(b.length){var f=0;for(var g in b){var h=new Audio;h.onload=function(){++f<b.length?e&&e(f*100/b.length):d()},h.preload="auto",h.autoplay=!1,h.loop=!1,h.src=a+"/"+b[g],c[b[g]]=h}}else d()},this.getSound=function(a){return c[a]},this.playSound=function(a,b){a in c&&(c[a].loop=!!b,c[a].play())}},Canvace.View=function(a,b){function j(a,b,c){this.tick=function(d){var j=e,k=f,l=(g-a)/2,m=(h-b)/2,n=d.getProjectedRectangle();e+n.x+n.width>g-l&&(j=g-n.x-n.width-l),e+n.x<l&&(j=l-n.x),f+n.y+n.height>h-m&&(k=h-n.y-n.height-m),f+n.y<m&&(k=m-n.y),e=e+(j-e)*(1-c),f=f+(k-f)*(1-c),i.fastForEach(function(a){a(e,f)})}}var c=a.matrix,d=function(){var a=c[0][0]*c[1][1]*c[2][2]+c[0][1]*c[1][2]*c[2][0]+c[0][2]*c[1][0]*c[2][1]-c[0][2]*c[1][1]*c[2][0]-c[0][1]*c[1][0]*c[2][2]-c[0][0]*c[1][2]*c[2][1];return[[(c[1][1]*c[2][2]-c[2][1]*c[1][2])/a,(c[0][2]*c[2][1]-c[2][2]*c[0][1])/a,(c[0][1]*c[1][2]-c[1][1]*c[0][2])/a],[(c[1][2]*c[2][0]-c[2][2]*c[1][0])/a,(c[0][0]*c[2][2]-c[2][0]*c[0][2])/a,(c[0][2]*c[1][0]-c[1][2]*c[0][0])/a],[(c[1][0]*c[2][1]-c[2][0]*c[1][1])/a,(c[0][1]*c[2][0]-c[2][1]*c[0][0])/a,(c[0][0]*c[1][1]-c[1][0]*c[0][1])/a]]}(),e=a.x0,f=a.y0,g=b.width,h=b.height;this.project=function(a,b,d){return[c[0][0]*a+c[0][1]*b+c[0][2]*d,c[1][0]*a+c[1][1]*b+c[1][2]*d,Math.round(c[2][0]*a+c[2][1]*b+c[2][2]*d)]},this.projectElement=function(a,b,d,e){return[Math.round(c[0][0]*b+c[0][1]*d+c[0][2]*e+a.offset.x),Math.round(c[1][0]*b+c[1][1]*d+c[1][2]*e+a.offset.y),Math.round(c[2][0]*b+c[2][1]*d+c[2][2]*e)]},this.unproject=function(a,b,c){var g=(c+d[2][0]*(e-a)+d[2][1]*(f-b))/d[2][2],h=d[0][0]*(a-e)+d[0][1]*(b-f)+d[0][2]*g,i=d[1][0]*(a-e)+d[1][1]*(b-f)+d[1][2]*g;return[h,i,c]},this.getCell=function(a,b,c){var g=(c-d[2][0]*(a-e)-d[2][1]*(b-f))/d[2][2],h=Math.round(d[0][0]*(a-e)+d[0][1]*(b-f)+d[0][2]*g),i=Math.round(d[1][0]*(a-e)+d[1][1]*(b-f)+d[1][2]*g);return{i:h,j:i,k:c}},this.getOrigin=function(){return{x:e,y:f}},this.getWidth=function(){return g},this.getHeight=function(){return h};var i=new Canvace.MultiSet;this.drag=function(a,b){e+=a,f+=b,i.fastForEach(function(a){a(e,f)})},this.dragTo=function(a,b){e=a,f=b,i.fastForEach(function(a){a(e,f)})},this.onDrag=function(a){return i.add(a)},this.createSynchronizer=function(a,b,c){return new j(a,b,c)}},Canvace.FrameTable=function(a){function g(a,b){var c;while(b)c=b,b=a%b,a=c;return a}function h(a){if(a.length<2)return function(){return a[0].id};var b=0,c=0;for(var d in a)if("duration"in a[d])b=g(b,a[d].duration),c+=a[d].duration;else return function(){return a[d].id};var e={},h=0;function i(d){e={},h=g(b,d);var f=0,i=0;for(var j=0;j<c;j+=h,i+=h)i>a[f].duration&&(f++,i=0),e[j]=a[f].id}return i(b),f.push(i),function(a){return e[Math.floor(a%c/h)*h]}}var b={},c={},d={},e=0,f=[];this.registerTile=function(c){if(a.tiles.hasOwnProperty(c))d[b[c]=e++]=new h(a.tiles[c].frames);else throw"invalid tile ID: "+c},this.registerEntity=function(b){if(a.entities.hasOwnProperty(b))d[c[b]=e++]=new h(a.entities[b].frames);else throw"invalid entity ID: "+b},this.getTileAnimation=function(a){return d[b[a]]},this.getEntityAnimation=function(a){return d[c[a]]},this.synchronize=function(a){for(var b in f)f[b](a)}},Canvace.Buckets=new function(){var a=1,b=1,c=function(c,d){function j(){var a={},b=0,c=0;this.add=function(d,e,f,g){return b=Math.min(b,d[2]),c=Math.max(c,d[2]),a[d[2]]||(a[d[2]]=new Canvace.MultiSet),a[d[2]].add({p:d,width:e,height:f,getFrame:g})},this.forEach=function(d){for(var e=b;e<=c;e++)a.hasOwnProperty(e)&&a[e].fastForEach(d)}}function l(){this.updatePosition=function(){},this.remove=function(){},this.replace=function(){}}function m(a,b,e,f,n){function u(b,c){var d=b+" "+c;k.hasOwnProperty(d)||(k[d]=new j),s.push(k[d].add(o,a.width,a.height,r))}function v(){u(p-1,q-1),u(p-1,q),u(p,q-1),u(p,q);var b=Math.floor((o[1]+a.height)/h),c=Math.floor((o[0]+a.width)/g);b>p&&(u(p+1,q-1),u(p+1,q)),c>q&&(u(p-1,q+1),u(p,q+1)),b>p&&c>q&&u(p+1,q+1)}function w(){for(var a in s)s[a]();return s=[],t=!0,!0}if(!a.frames.length)return new l;var o=c.projectElement(a,e,f,n),p=Math.floor(o[1]/h),q=Math.floor(o[0]/g),r=b(),s=[],t=!1;v(),this.getProjectedPosition=function(){return{x:o[0]-a.offset.x,y:o[1]-a.offset.y,z:o[2]}},this.getProjectedRectangle=function(){return{x:o[0],y:o[1],z:o[2],width:a.width,height:a.height}},this.updatePosition=function(b,d,i){if(!t){var j=c.projectElement(a,e=b,f=d,n=i),k=Math.floor(o[1]/h),l=Math.floor(o[0]/g);j[2]!=o[2]||k!=p||l!=q?(w(),t=!1,o[0]=j[0],o[1]=j[1],o[2]=j[2],p=k,q=l,v()):(o[0]=j[0],o[1]=j[1],o[2]=j[2])}},this.remove=w,this.replace=function(a){if(!t){if(a in d.entities){w();var b=d.entities[a];return new m(b,function(){return i.getEntityAnimation(a)},e,f,n)}throw{message:"invalid entity ID",id:a}}}}function o(a,b,c,e){if(a in d.tiles){var f=d.tiles[a],g=(new m(f,function(){return i.getTileAnimation(a)},b,c,e)).remove;if(f.mutable){n[e]||(n[e]={}),n[e][b]||(n[e][b]={});var h=!1;return n[e][b][c]=function(){return g(),h?!1:(delete n[e][b][c],h=!0,!0)}}return g}throw{message:"invalid tile ID",id:a}}var e=c.getWidth(),f=c.getHeight(),g=Math.round(e*a),h=Math.round(f*b),i=new Canvace.FrameTable(d),k={},n={};this.addTile=o,this.addEntity=function(a,b,c,e){if(a in d.entities){var f=d.entities[a];return new m(f,function(){return i.getEntityAnimation(a)},b,c,e)}throw{message:"invalid entity ID",id:a}},this.removeTile=function(a,b,c){return n[c]&&n[c][a]&&n[c][a][b]&&n[c][a][b]()||!1},this.replaceTile=function(a,b,c,d){if(n[c]&&n[c][a]&&n[c][a][b]&&n[c][a][b]())return o(d,a,b,c)},this.registerTile=i.registerTile,this.registerEntity=i.registerEntity,this.synchronize=i.synchronize,this.forEachElement=function(a,b){var d=c.getOrigin(),i=Math.floor(-d.y/h),j=Math.floor(-d.x/g),l=i+" "+j;k.hasOwnProperty(l)&&k[l].forEach(function(c){c.p[0]<-d.x+e&&c.p[1]<-d.y+f&&c.p[0]+c.width>=-d.x&&c.p[1]+c.height>=-d.y&&b(c.p[0],c.p[1],c.getFrame(a))})}};return c.setBucketSizeFactors=function(c,d){if(c<1)throw"illegal width factor: "+c;if(d<1)throw"illegal height factor: "+d;a=c,b=d},c},Canvace.Renderer=function(a,b,c,d,e,f){var g=a.width,h=a.height,i=a.getContext("2d");this.getView=function(){return c},this.getBuckets=function(){return d},this.synchronize=d.synchronize,this.getContext=function(){return i},this.render=function(a){var j=c.getOrigin();i.setTransform(1,0,0,1,j.x,j.y),i.clearRect(-j.x,-j.y,g,h),e&&e(i),d.forEachElement(a,function(a,c,d){i.drawImage(b.getImage(d),a,c)}),f&&f(i)}},Canvace.TileMap=function(a,b){function d(b){var c=a.tiles[b];this.isWalkable=function(){return c.walkable},this.getProperties=function(){return c.properties}}var c=a.map;this.forEachLayer=function(a){for(var b in c)if(a(parseInt(b))===!1)return!0;return!1},this.forEachTile=function(a){for(var b in c){b=parseInt(b);for(var d in c[b]){d=parseInt(d);for(var e in c[b][d]){e=parseInt(e);if(a(d,e,b)===!1)return!0}}}return!1},this.forEachTileInLayer=function(a,b){if(a in c){for(var d in c[a]){d=parseInt(d);for(var e in c[a][d]){e=parseInt(e);if(b(d,e)===!1)return!0}}return!1}throw"invalid layer number: "+a},this.getTile=function(b){if(b in a.tiles)return new d(b);throw"invalid tile id: "+b},this.getAt=function(a,b,d){return c[d]&&c[d][a]&&c[d][a][b]||!1},this.putAt=function(d,e,f,g){if(!(g in a.tiles))throw{message:"invalid tile ID",id:g};if(!(f in c&&d in c[f]&&e in c[f][d]))return f in c||(c={}),d in c[f]||(c[f]={}),c[f][d][e]=g,b.addTile(g,d,e,f),!0;if(b.replaceTile(d,e,f,g))c[f][d][e]=g;else return!1},this.getGraphNode=function(b,d,e,f,g){return function h(b,d){function i(a,b){return function(){return h(a,b)}}var j=Math.abs(f-b),l=Math.abs(g-d),m={id:b+" "+d+" "+e,heuristic:Math.sqrt(Math.pow(Math.min(j,l),2)*2)+Math.max(j,l)-Math.min(j,l),neighbors:{},distance:function(a){return parseInt(a)%2?1:Math.sqrt(2)}};return function(){function f(b,d){return b in c[e]&&d in c[e][b]&&a.tiles[c[e][b][d]].walkable}for(var g=0;g<9;g++){var h=b+[-1,-1,-1,0,0,0,1,1,1][g],j=d+[-1,0,1,-1,0,1,-1,0,1][g];h!=b&&j!=d&&f(h,j)&&(g%2||f(b,j)&&f(h,d))&&(m.neighbors[g]=i(h,j))}}(),m}(b,d)},this.rectangleCollision=function(b,c,d,e,f,g,h,i,j,k,l){var m=0,n=0,o=0,p=0,q=a.map;if(b in a.map){var r=a.tiles,s=function(){return typeof l!="function"?function(a,c){return a in q[b]&&c in q[b][a]&&!r[q[b][a][c]].walkable}:function(a,c){var d=r[q[b][a][c]];return a in q[b]&&c in q[b][a]&&l(d.walkable,d.properties)}}(),t=Math.floor(c),u=Math.floor(d),v=Math.ceil(c+e)-1,w=Math.ceil(d+f)-1;for(var x=u;x<=w;x++)s(t,x)&&(t==v||!s(t+1,x))&&(m=t+1-c),s(v,x)&&(t==v||!s(v-1,x))&&(n=v-c-e);for(var y=t;y<=v;y++)s(y,u)&&(u==w||!s(y,u+1))&&(o=u+1-d),s(y,w)&&(u==w||!s(y,w-1))&&(p=w-d-f)}var z={};m&&n?z.i=0:m?z.i=m:z.i=n,o&&p?z.j=0:o?z.j=o:z.j=p;var A=k*k*.5;return Math.abs(z.i)>Math.abs(g*k+i*A)+.001&&(z.i=0),Math.abs(z.j)>Math.abs(h*k+j*A)+.001&&(z.j=0),z}},Canvace.Stage=function(a,b){function h(a,b,c){for(var d in b)if(b.hasOwnProperty(d)){var e;if(d in a)e=a[d];else if(d in c)e=c[d];else return!1;if(typeof b[d]!="object"){if(e!==b[d])return!1}else if(typeof e!="object"||!h(e,b[d],{}))return!1}return!0}function i(b){var c=a.entities[b=parseInt(b)];b in e||(e[b]=this),this.getId=function(){return b},this.getProperties=function(){return c.properties},this.isPhysicsEnabled=function(){return c.enablePhysics},this.getBoundingBox=function(){var a={i0:c.box.i0,j0:c.box.j0,iSpan:c.box.iSpan,jSpan:c.box.jSpan};return function(){return a}}(),this.forEachInstance=function(a,d){return d||(d={}),f.forEach(function(e){if(b==e.getEntityId()&&h(e.getProperties(),d,c.properties))return a(e)})},this.createInstance=function(a,c,e){return new j({id:b,i:a,j:c,k:e,position:{i:a,j:c,k:e},velocity:{i:0,j:0,k:0},uniformVelocity:{i:0,j:0,k:0},acceleration:{i:0,j:0,k:0},properties:{}},d.addEntity(b,a,c,e))}}function j(b,h){var k,l;typeof b!="number"?(k=null,l=b):(k=b,l=a.instances[k]);var m=a.entities[l.id],n=f.add(this);m.enablePhysics&&(n=function(a,b){return function(){return a()&&b()}}(n,g.add(this))),this.getId=function(){return k},this.getProperties=function(){return l.properties},this.getEntityId=function(){return l.id},this.getEntity=function(){return e[l.id]||new i(l.id)},this.getPosition=function(){return l.position},this.getProjectedPosition=h.getProjectedPosition,this.getProjectedRectangle=h.getProjectedRectangle,this.inRange=function(){var a=c.getWidth(),b=c.getHeight();return function(d,e){var f=h.getProjectedPosition(),g=c.getOrigin(),i=(d-a)/2,j=(e-b)/2;return f.x>=-g.x-i&&f.x<=-g.x+a+i&&f.y>=-g.y-j&&f.y<=-g.y+b+j}}(),this.getVelocity=function(){return l.velocity},this.getUniformVelocity=function(){return l.uniformVelocity},this.getFullVelocity=function(){var a={i:l.velocity.i+l.uniformVelocity.i,j:l.velocity.j+l.uniformVelocity.j,k:l.velocity.k+l.uniformVelocity.k};return function(){return a.i=l.velocity.i+l.uniformVelocity.i,a.j=l.velocity.j+l.uniformVelocity.j,a.k=l.velocity.k+l.uniformVelocity.k,a}}(),this.getAcceleration=function(){return l.acceleration},this.testTileCollision=function(a,b,c){return a.rectangleCollision(Math.floor(l.k),l.position.i+m.box.i0,l.position.j+m.box.j0,m.box.iSpan,m.box.jSpan,l.velocity.i+l.uniformVelocity.i,l.velocity.j+l.uniformVelocity.j,l.acceleration.i,l.acceleration.j,b,c)},this.tileCollision=function(a,b,c){var d=a.rectangleCollision(Math.floor(l.k),l.position.i+m.box.i0,l.position.j+m.box.j0,m.box.iSpan,m.box.jSpan,l.velocity.i+l.uniformVelocity.i,l.velocity.j+l.uniformVelocity.j,l.acceleration.i,l.acceleration.j,b,c);return l.position.i+=d.i,l.position.j+=d.j,d.i>0&&l.velocity.i<0?l.velocity.i=0:d.i<0&&l.velocity.i>0&&(l.velocity.i=0),d.j>0&&l.velocity.j<0?l.velocity.j=0:d.j<0&&l.velocity.j>0&&(l.velocity.j=0),d},this.rectangleCollision=function(a,b,c,d,e,f,g,h,i){var j={i:0,j:0};a<l.position.i+m.box.i0?a+c>l.position.i+m.box.i0&&(b<l.position.j+m.box.j0?b+d>l.position.j+m.box.j0&&(a+c<l.position.i+m.box.i0+m.box.iSpan&&(j.i=l.position.i+m.box.i0-a-c),b+d<l.position.j+m.box.j0+m.box.jSpan&&(j.j=l.position.j+m.box.j0-b-d)):b<l.position.j+m.box.j0+m.box.jSpan&&(a+c<l.position.i+m.box.i0+m.box.iSpan&&(j.i=l.position.i+m.box.i0-a-c),b+d>l.position.j+m.box.j0+m.box.jSpan&&(j.j=l.position.j+m.box.j0-b-d))):a<l.position.i+m.box.i0+m.box.iSpan&&(b<l.position.j+m.box.j0?b+d>l.position.j+m.box.j0&&(j.i=l.position.i+m.box.i0+m.box.iSpan-a,b+d<l.position.j+m.box.j0+m.box.jSpan&&(j.j=l.position.j+m.box.j0-b-d)):b<l.position.j+m.box.j0+m.box.jSpan&&(a+c>l.position.i+m.box.i0+m.box.iSpan&&(j.i=l.position.i+m.box.i0+m.box.iSpan-a),b+d>l.position.j+m.box.j0+m.box.jSpan&&(j.j=l.position.j+m.box.j0+m.box.jSpan-b)));var k=i*i*.5;return Math.abs(j.i)>Math.abs((l.velocity.i+l.uniformVelocity.i-e)*i+(l.acceleration.i-g)*k)+.001&&(j.i=0),Math.abs(j.j)>Math.abs((l.velocity.j+l.uniformVelocity.j-f)*i+(l.acceleration.j-h)*k)+.001&&(j.j=0),j},this.testCollision=function(a,b){return a.rectangleCollision(l.position.i+m.box.i0,l.position.j+m.box.j0,m.box.iSpan,m.box.jSpan,l.velocity.i+l.uniformVelocity.i,l.velocity.j+l.uniformVelocity.j,l.acceleration.i,l.acceleration.j,b)},this.collision=function(a,b){var c=a.rectangleCollision(l.position.i+m.box.i0,l.position.j+m.box.j0,m.box.iSpan,m.box.jSpan,l.velocity.i+l.uniformVelocity.i,l.velocity.j+l.uniformVelocity.j,l.acceleration.i,l.acceleration.j,b);return l.position.i+=c.i,l.position.j+=c.j,c.i>0&&l.velocity.i<0?l.velocity.i=0:c.i<0&&l.velocity.i>0&&(l.velocity.i=0),c.j>0&&l.velocity.j<0?l.velocity.j=0:c.j<0&&l.velocity.j>0&&(l.velocity.j=0),c},this.tick=function(a){var b=a*a*.5;l.position.i+=(l.velocity.i+l.uniformVelocity.i)*a+l.acceleration.i*b,l.position.j+=(l.velocity.j+l.uniformVelocity.j)*a+l.acceleration.j*b,l.position.k+=(l.velocity.k+l.uniformVelocity.k)*a+l.acceleration.k*b,l.velocity.i+=l.acceleration.i*a,l.velocity.j+=l.acceleration.j*a,l.velocity.k+=l.acceleration.k*a},this.update=function(){h.updatePosition(l.position.i,l.position.j,l.position.k)},this.remove=function(){h.remove(),n()},this.replaceWith=function(a){if(n())return new j(l,h.replace(l.id=a.getId()));throw"the instance cannot be replaced because it has been removed"},this.fork=function(a){var b=a?a.getId():l.id;return new j({id:b,i:l.i,j:l.j,k:l.k,position:{i:l.position.i,j:l.position.j,k:l.position.k},velocity:{i:l.velocity.i,j:l.velocity.j,k:l.velocity.k},uniformVelocity:{i:l.uniformVelocity.i,j:l.uniformVelocity.j,k:l.uniformVelocity.k},acceleration:{i:l.acceleration.i,j:l.acceleration.j,k:l.acceleration.k},properties:{}},d.addEntity(b,l.position.i,l.position.j,l.position.k))}}var c=new Canvace.View(a,b),d=new Canvace.Buckets(c,a);(function(){for(var b in a.tiles)d.registerTile(b);for(var b in a.entities)d.registerEntity(b)})();var e={},f=new Canvace.MultiSet,g=new Canvace.MultiSet;(function(){for(var b in a.map){b=parseInt(b);for(var c in a.map[b]){c=parseInt(c);for(var e in a.map[b][c])e=parseInt(e),d.addTile(a.map[b][c][e],c,e,b)}}for(var f in a.instances){var g=a.instances[f];g.position={i:g.i,j:g.j,k:g.k},g.velocity={i:0,j:0,k:0},g.uniformVelocity={i:0,j:0,k:0},g.acceleration={i:0,j:0,k:0},new j(parseInt(f),d.addEntity(g.id,g.i,g.j,g.k))}})(),this.getName=function(){return a.name},this.getProperties=function(){return a.properties},this.getCanvas=function(){return b},this.getView=function(){return c},this.getBuckets=function(){return d};var k=null;this.getTileMap=function(){return k||(k=new Canvace.TileMap(a,d))},this.forEachEntity=function(b,c){c||(c={});for(var d in a.entities)if(a.entities.hasOwnProperty(d)&&h(a.entities[d].properties,c,{})&&b(e[d]||new i(d))===!1)return!0;return!1},this.getEntity=function(b){for(var c in a.entities)if(a.entities.hasOwnProperty(c)&&h(a.entities[c].properties,b,{}))return e[c]||new i(c);return null},this.forEachInstance=function(a,b){return b||(b={}),f.forEach(function(c){if(h(c.getProperties(),b,c.getEntity().getProperties()))return a(c)})},this.getInstance=function(a){var b=null;return f.forEach(function(c){if(h(c.getProperties(),a,c.getEntity().getProperties()))return b=c,!1}),b},this.Range=function(a,b){this.forEachInstance=function(c,d){return d||(d={}),f.forEach(function(e){if(e.inRange(a,b)&&h(e.getProperties(),d,e.getEntity().getProperties()))return c(e)})},this.tick=function(c){g.fastForEach(function(d){d.inRange(a,b)&&d.tick(c)})},this.update=function(){g.fastForEach(function(c){c.inRange(a,b)&&c.update()})}},this.tick=function(a){g.fastForEach(function(b){b.tick(a)})},this.update=function(){g.fastForEach(function(a){a.update()})}},Canvace.StageRenderer=function(a,b){var c=[],d=new Canvace.Renderer(a.getCanvas(),b,a.getView(),a.getBuckets(),function(a){for(var b=0;b<c.length;b++)c[b].isOver()?c.splice(b--,1):c[b].preProcess&&c[b].preProcess(a)},function(a){for(var b=c.length-1;b>=0;b--)c[b].postProcess&&c[b].postProcess(a)});return d.addEffect=function(a){c.push(a)},d},Canvace.RumbleEffect=function(a){this.preProcess=function(b){!(--a>0)},this.isOver=function(){return a<=0}},Canvace.RenderLoop=function(){var a="auto",b=60,c=function(c,d,e,f,g){function s(){if(!k||l){k=!0,l=!1;function a(a){m.tick(a),f&&f(a)}var b=Date.now(),c=b;q=o(function d(e){var f=e-c;c=e;while(f>j)a(j/1e3),f-=j;a(f/1e3),m.update(),g&&g(),r++,h.render(Math.round(e)-b),q=o(d)},n)}}function t(){if(!k||l){k=!0,l=!1;function a(a){m.tick(a),f&&f(a)}var b=Date.now();q=setInterval(function(){var c=Date.now(),d=Math.max(0,c-b);while(d>j)a(j/1e3),d-=j;a(d/1e3),m.update(),g&&g(),h.render(r++*j),b=Date.now()},j)}}var h=new Canvace.StageRenderer(c,e),i=b,j=Math.floor(1e3/i),k=!1,l=!1,m=d||c,n=c.getCanvas(),o=function(){return window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame}(),p=function(){return window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame}(),q;h.synchronize(j),this.getRate=function(){return i};var r=0;this.getActualRate=function(){var a=Date.now();return function(){if(k&&!l){var b=Date.now(),c=r*1e3/(b-a);return r=0,a=b,c}return null}}(),this.getPeriod=function(){return j},this.getStage=function(){return c},this.getRenderer=function(){return h};var u;a==="request"?u=p:a==="interval"?u=clearInterval:o?u=p:u=clearInterval,a==="request"?this.run=s:a==="interval"?this.run=t:o?this.run=s:this.run=t,this.suspend=function(){k&&!l&&(u(q),l=!0)},this.isSuspended=function(){return k&&l},this.stop=function(){k&&(u(q),k=!1,l=!0)},this.isStopped=function(){return!k&&l}};return c.setLoop=function(c,d){if(c in{request:!0,interval:!0,auto:!0})a=c,typeof d=="number"&&(b=d);else throw'invalid loop type; only "request", "interval" and "auto" are allowed.'},c}();